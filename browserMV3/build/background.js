'use strict';// background
var isChrome=function isChrome(){return /Chrome/.test(navigator.userAgent)};window.app=isChrome()?chrome:browser;window.app.runtime.onMessage.addListener(function(request,sender,sendResponse){var cmd=request.command;// 外部サイトで発動する機能を有効にする
if(cmd==='enable-daiiz-script'){var funcProjectPairs=request.func_project_pairs;var funcNames=Object.keys(funcProjectPairs);for(var i=0;i<funcNames.length;i++){var funcName=funcNames[i];var projectName=funcProjectPairs[funcName];if(!funcName||funcName.length===0)return;if(!projectName||projectName.length===0){localStorage.removeItem(funcName)}else if(projectName.length>0){localStorage[funcName]=projectName}}return}// 設定された値を返す
if(cmd==='get-project-name'){var funcNames=request.func_names;var projectNames={};for(var i=0;i<funcNames.length;i++){var funcName=funcNames[i];if(localStorage[funcName]){projectNames[funcName]=localStorage[funcName]}}sendResponse(projectNames);return}// Clipboardに保持されたURLのページタイトルを返却する
if(cmd==='get-clipboard-page'){var bg=window.app.extension.getBackgroundPage();var textarea=document.querySelector('#daiiz-ctrlv');textarea.value='';textarea.focus();bg.document.execCommand('paste');resopondWebpageTitleOrRawText(textarea.value,sendResponse)}// URLのページタイトルを返却する
if(cmd==='fetch-page-title'){var text=request.rawText;resopondWebpageTitleOrRawText(text,sendResponse)}});var resopondWebpageTitleOrRawText=function resopondWebpageTitleOrRawText(text,sendResponse){if(text.match(/\n/))return sendResponse(text);if(text.match(/^https?:\/\/scrapbox\.io\//))return sendResponse(text);if(text.match(/gyazo\.com\//))return sendResponse(text);if(text.match(/www\.youtube\.com\//))return sendResponse(text);if(text.match(/www\.google/)&&text.match(/\/maps\//))return sendResponse(text);if(text.match(/^https?:\/\//)){fetchPage(text);return}sendResponse(text)};var fetchPage=async function fetchPage(url){var res=await fetch(url,{credentials:'include'});var body=await res.text();var parser=new DOMParser;var doc=parser.parseFromString(body,'text/html');console.log(doc.title);var externalLink=url;var title=doc.title||null;if(title)externalLink='['+url+' '+title+']';console.log(externalLink);if(isChrome()){window.app.tabs.getSelected(null,function(tab){window.app.tabs.sendMessage(tab.id,{command:'re:get-clipboard-page',externalLink:externalLink})})}else{// Firefox extension
var tab=await window.app.tabs.query({currentWindow:true,active:true});window.app.tabs.sendMessage(tab[0].id,{command:'re:get-clipboard-page',externalLink:externalLink})}};